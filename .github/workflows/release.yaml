name: Release

on:
    release:
        types: [published]

env:
    IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

            - name: Log in to GHCR
              uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push image
              run: |
                  TAG="${{ github.event.release.tag_name }}"
                  docker build -t "$IMAGE_NAME:$TAG" -t "$IMAGE_NAME:latest" .
                  docker push "$IMAGE_NAME:$TAG"
                  docker push "$IMAGE_NAME:latest"
